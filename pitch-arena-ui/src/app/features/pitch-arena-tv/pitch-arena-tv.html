<div class="min-h-screen" style="background: var(--color-bg); color: var(--color-text);">
  <div class="mx-auto w-full max-w-6xl px-4 py-6 md:py-10 space-y-5">

    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-3 md:gap-4 rounded-2xl border px-3 py-3 md:px-4 md:py-4"
         style="border-color: var(--color-border); background: var(--color-surface); box-shadow: var(--shadow-elev);">
      <div class="flex flex-wrap items-center gap-2">
        <button
          type="button"
          class="rounded-xl border px-3 py-2 text-xs font-semibold transition active:scale-[0.99]"
          style="border-color: var(--color-border); background: color-mix(in srgb, var(--color-surface) 90%, var(--color-text) 10%);"
          (click)="exportConversation()"
          title="Download the current conversation as JSON"
        >
          ‚¨á Export conversation
        </button>
      </div>

      <div class="flex w-full flex-col md:flex-row items-stretch md:items-center gap-2">
        <input
          type="text"
          class="w-full rounded-xl border px-3 py-2 text-sm outline-none transition"
          [ngModel]="repromptInput()"
          (ngModelChange)="repromptInput.set($event)"
          placeholder="Re-prompt using this conversation‚Ä¶"
          style="border-color: var(--color-border); background: color-mix(in srgb, var(--color-bg) 55%, var(--color-surface)); color: var(--color-text);"
        />
        <button
          type="button"
          class="shrink-0 rounded-xl px-4 py-2 text-sm font-semibold transition active:scale-[0.99] disabled:opacity-40 disabled:pointer-events-none"
          
          (click)="repromptConversation()"
          [disabled]="!repromptInput().trim().length || reprompting()"
          title="Send the transcript to the AI with your custom prompt"
        >
          @if (reprompting()) { Thinking‚Ä¶ }
          @else { Re-prompt }
        </button>
      </div>
    </div>

    <!-- Header -->
    <div class="flex items-center justify-between gap-3">
      <div>
        <h1 class="text-lg md:text-xl font-semibold tracking-tight">Pitch Arena</h1>
        <p class="text-xs md:text-sm" style="color: var(--color-muted);">
          {{ phaseLabel() }} ‚Ä¢ Round {{ round() }}
        </p>
      </div>

      <button
        type="button"
        class="rounded-xl border px-3 py-1.5 text-xs transition active:scale-[0.99]"
        style="border-color: var(--color-border); background: var(--color-surface);"
        (click)="reset()"
      >
        Reset
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[320px_1fr] gap-4 md:gap-6 items-start">
      <div class="space-y-3">
        <!-- Judges row -->
        <div class="grid grid-cols-2 md:grid-cols-1 gap-3">
          @for (j of judges; track j.id) {
            <div
              class="rounded-2xl border px-3 py-3 md:px-4 md:py-4 transition"
              style="background: var(--color-surface); border-color: var(--color-border); box-shadow: var(--shadow-elev);"
              [ngClass]="{
                'scale-[1.03]': judgeState(j.id) === 'active',
                'opacity-70': judgeState(j.id) === 'idle',
                'opacity-95': judgeState(j.id) === 'passed'
              }"
            >
              <div class="flex items-center gap-3">
                <div
                  class="h-10 w-10 rounded-full grid place-items-center text-lg shrink-0 border"
                  style="border-color: var(--color-border);
                         background: color-mix(in srgb, var(--color-surface) 88%, var(--color-text) 12%);"
                  [ngStyle]="judgeState(j.id) === 'active'
                    ? { borderColor: 'var(--color-accent)', boxShadow: '0 0 0 3px color-mix(in srgb, var(--color-accent) 20%, transparent)' }
                    : null"
                >
                  {{ judgeBadge(j.id) }}
                </div>

                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <p class="text-sm font-semibold truncate">{{ j.label }}</p>

                    @if (judgeState(j.id) === 'active') {
                      <span class="text-[10px] px-2 py-0.5 rounded-full border"
                            style="border-color: var(--color-border);
                                   background: color-mix(in srgb, var(--color-accent) 8%, var(--color-surface));">
                        speaking
                      </span>
                    }
                    @if (judgeState(j.id) === 'passed') {
                      <span class="text-[10px] px-2 py-0.5 rounded-full border"
                            style="border-color: var(--color-border);
                                   background: color-mix(in srgb, var(--color-success) 10%, var(--color-surface));">
                        ‚úì
                      </span>
                    }
                  </div>

                  <p class="text-xs truncate" style="color: var(--color-muted);">{{ j.dimension }}</p>
                </div>
              </div>

              <div class="mt-3 h-[2px] w-full rounded-full"
                   [ngStyle]="judgeState(j.id) === 'active' ? { background: 'var(--color-accent)' } : { background: 'transparent' }">
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Chat window -->
      <div class="rounded-2xl border overflow-hidden"
           style="border-color: var(--color-border); background: var(--color-surface); box-shadow: var(--shadow-elev);">

      <div class="flex items-center justify-between px-4 py-3 border-b" style="border-color: var(--color-border);">
        <div class="flex items-center gap-2 min-w-0">
          <span class="text-xs px-2 py-1 rounded-full border"
                style="border-color: var(--color-border);
                       background: color-mix(in srgb, var(--color-surface) 92%, var(--color-text) 8%);">
            üèüÔ∏è Arena Thread
          </span>
          <span class="text-xs truncate" style="color: var(--color-muted);">
            {{ phaseLabel() }}
          </span>
        </div>

        <div class="text-xs" style="color: var(--color-muted);">
          Overall: <span class="font-semibold" style="color: var(--color-text);">{{ overallScore().toFixed(1) }}</span>
          @if (overallDelta() !== null) {
            <span>({{ overallDelta()! >= 0 ? '+' : '' }}{{ overallDelta()!.toFixed(1) }})</span>
          }
        </div>
      </div>

      <div #chatWindow class="h-[54vh] md:h-[58vh] overflow-y-auto px-4 py-4 space-y-4">
        @for (m of chat(); track m.id) {
          @if (m.role === 'system') {
            <div class="flex justify-center">
              <div class="text-[11px] px-3 py-1 rounded-full border"
                   style="border-color: var(--color-border);
                          background: color-mix(in srgb, var(--color-bg) 60%, var(--color-surface));
                          color: var(--color-muted);">
                <span class="font-semibold" style="color: var(--color-text);">{{ m.title }}</span>
                <span class="ml-2">{{ m.text }}</span>
              </div>
            </div>
          }

          @if (m.role === 'judge') {
<div class="flex items-start gap-3">
  <div class="h-9 w-9 rounded-full grid place-items-center border shrink-0"
       style="border-color: var(--color-border);
              background: color-mix(in srgb, var(--color-surface) 92%, var(--color-text) 8%);">
    {{ judgeBadge(m.judgeId!) }}
  </div>

  <div class="min-w-0">
    <div class="flex items-center justify-between gap-2">
      @if (m.title) {
        <p class="text-[11px]" style="color: var(--color-muted);">{{ m.title }}</p>
      } @else {
        <span></span>
      }

      <div class="flex items-center gap-2">
        <button
          type="button"
          class="text-[11px] px-2 py-1 rounded-full border transition active:scale-[0.99]"
          style="border-color: var(--color-border);
                 background: var(--color-surface);"
          (click)="ensureVoice(m.id)"
          [disabled]="m.audioState === 'loading'"
          title="Generate voice"
        >
          @if (m.audioState === 'loading') { ‚Ä¶ }
          @else { üîä }
        </button>

        @if (m.audioUrl) {
          <button
            type="button"
            class="text-[11px] px-2 py-1 rounded-full border transition active:scale-[0.99]"
            style="border-color: var(--color-border);
                   background: color-mix(in srgb, var(--color-accent) 8%, var(--color-surface));"
            (click)="playMsg(m)"
            title="Play / stop"
          >
            @if (currentlyPlayingMsgId() === m.id) { ‚è∏ }
            @else { ‚ñ∂ }
          </button>
        }
      </div>
    </div>

    <div class="mt-1 inline-block max-w-[42rem] rounded-2xl border px-3 py-2"
         style="border-color: var(--color-border);
                background: color-mix(in srgb, var(--color-bg) 60%, var(--color-surface));
                color: var(--color-text);">
      <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ m.text }}</p>
    </div>

    @if (m.audioState === 'error') {
      <p class="mt-1 text-[11px]" style="color: var(--color-danger);">
        Voice generation failed.
      </p>
    }
  </div>
</div>

          }

          @if (m.role === 'user') {
            <div class="flex justify-end">
              <div class="max-w-[42rem] rounded-2xl border px-3 py-2"
                   style="border-color: color-mix(in srgb, var(--color-accent) 35%, var(--color-border));
                          background: color-mix(in srgb, var(--color-accent) 10%, var(--color-surface));
                          color: var(--color-text);">
                <p class="text-sm leading-relaxed whitespace-pre-wrap">{{ m.text }}</p>
              </div>
            </div>
          }
        }
      </div>

      <div class="border-t p-3 md:p-4" style="border-color: var(--color-border);">
        <div class="flex items-end gap-2">
          <textarea
            class="w-full min-h-[44px] max-h-[140px] rounded-xl border px-3 py-2 text-sm outline-none transition resize-none"
            [ngModel]="input()"
            (ngModelChange)="input.set($event)"
            placeholder="Type your answer‚Ä¶"
            [disabled]="phase() === 'judging' || phase() === 'results'"
            style="border-color: var(--color-border);
                   background: color-mix(in srgb, var(--color-bg) 55%, var(--color-surface));
                   color: var(--color-text);"
          ></textarea>

          @if (phase() === 'intro' || phase() === 'answering') {
            <button
              type="button"
              class="shrink-0 rounded-xl px-4 py-2 text-sm font-semibold transition active:scale-[0.99]
                     disabled:opacity-40 disabled:pointer-events-none"
              
              (click)="send()"
              [disabled]="!canSend()"
            >
              Send ‚Üí
            </button>
            <button
  type="button"
  class="rounded-xl px-3 py-2 border text-sm transition active:scale-[0.99]"
  style="border-color: var(--color-border); background: var(--color-surface);"
  (click)="recording() ? stopRecording() : startRecording()"
  title="Record voice"
>
  @if (recording()) {
    ‚èπ Stop
  } @else {
    üéô Speak
  }
</button>

          } @else if (phase() === 'results') {
            <button
              type="button"
              class="shrink-0 rounded-xl px-4 py-2 text-sm font-semibold transition active:scale-[0.99]
                     disabled:opacity-40 disabled:pointer-events-none"
              
              (click)="submitAnswersAndRescore()"
              [disabled]="!canRescore()"
            >
              Rescore ‚Üí
            </button>
          }
        </div>

        <div class="mt-2 flex items-center justify-between text-[11px]" style="color: var(--color-muted);">
          <span>{{ input().trim().length }} chars</span>
          <span>
            @if (phase() === 'intro') { Host is warming you up. }
            @if (phase() === 'judging') { Panel judging‚Ä¶ }
            @if (phase() === 'answering') { Answer to move to the next judge. }
            @if (phase() === 'results') { Rescore to advance. }
          </span>
        </div>
      </div>
    </div>

  </div>
</div>
